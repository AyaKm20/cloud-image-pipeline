{
  "_comment": "Build with packer build template.json",
  "builders": [
    {
      "type": "qemu",
      "iso_checksum": "sha256:95a3363a586c113618b3b2b69b40303ca30dd20406cde35560cea0ed015c8529",
      "iso_url": "https://cloud-images.ubuntu.com/releases/focal/20201124/focal-server-cloudimg-amd64.img",
      "disk_size": "{{user `disk_size`}}",
      "disk_image": true,
      "format": "qcow2",
      "disk_compression": true,
      "headless": true,
      "output_directory": "output-{{user `env`}}",
      "shutdown_command": "echo '{{user `ssh_password`}}' | sudo -S poweroff",
      "ssh_username": "{{user `ssh_username`}}",
      "ssh_password": "{{user `ssh_password`}}",
      "ssh_timeout": "10m",
      "ssh_wait_timeout": "0s",
      "ssh_port": 22,
      "ssh_pty": true,
      "ssh_handshake_attempts": "20",
      "vm_name": "ubuntu-{{user `env`}}.qcow2",
      "accelerator": "kvm",
      "net_device": "virtio-net",
      "use_default_display": true,
      "qemuargs": [
        ["-display", "gtk"],
        ["-machine", "accel=kvm"],
        ["-cpu", "host"],
        ["-m", "{{user `ram`}}M"],
        ["-smp", "{{user `cpu`}}"],
        ["-fda", "my-seed.img"],
        ["-serial", "mon:stdio"]
      ]
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "execute_command": "{{ .Vars }} sudo -E bash '{{ .Path }}'",
      "inline": [
        "sudo systemctl enable ssh",
        "sudo systemctl start ssh",
        "sudo apt update -y",
        "sudo apt -y install software-properties-common git ansible",
        "sudo sed -i 's/ens3/enp1s0/g' /etc/netplan/50-cloud-init.yaml"
      ],
      "expect_disconnect": true,
      "valid_exit_codes": [0]
    }
  ],
  "variables": {
    "env": "dev",
    "cpu": "2",
    "ram": "2048",
    "disk_size": "10000",
    "iso_url": "https://cloud-images.ubuntu.com/releases/focal/20201124/focal-server-cloudimg-amd64.img",
    "ssh_username": "ubuntu",
    "ssh_password": "ubuntu"
  }
}
